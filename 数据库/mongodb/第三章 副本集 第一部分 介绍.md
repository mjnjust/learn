[TOC]
# 3. 副本集

副本集，就是一组冗余的，可以做到高可用的mongo进程，这些进程被分为一个primary和N个secondary。primary可以接受所有的写请求，secondary通过oplog，从primary复制数据，保持着primary的一份数据副本。

## 3.1 副本集结构

### 3.1.1 成员
+ primary 
    * 副本集中的主节点，只有primary可以接受写请求。
+ secondary
    * 副本集中的从节点，通过主节点的oplog，保持着primary节点数据的副本，不能接受写请求。secondary有一些额外的配置参数来设定从节点所支持的能力，比如可以配置成不投票的从节点，无法成为主节点的从节点等。
    * 副本集中的成员都可以对外提供数据的读取服务，但是mongodb默认会将所有的读写请求都打到primary节点上。

### 3.1.2 secondary节点重要配置
+ priority=0 
    * 如果一个secondary成员priority被设置为0，那么该成员就无法成为主节点，但是具有投票权。
    * 使用场景
        - 仅仅作为备份节点，用于数据的冷备份。
        - 部署的时候，可以使用一些性能稍差的机器，priority设置为0，仅仅作为数据读取或者备份的节点，一些性能好的机器，priority设置大于0。如果primary挂了，那只有哪些性能好的节点会成为primary。
        - 多地区部署的时候，有些机房可能地理位置、硬件设施不太好，那么这些机房的secondary可以设置priority=0，避免成为primary。
    * 作用的总结
        可以让不适合作为primary的secondary节点，不会成为primary。什么时候不适合呢，就需要看业务场景、部署的设施条件、地理条件等。

+ hidden=true
    * 一般和priority=0配合使用，既不能成为primary，也不能提供数据的读取服务，但是具有投票权。

+ slaveDelay
    * 延迟同步节点，slaveDelay=3600,会延迟1小时同步primary的数据，也就是是说，节点的数据时primary 1小时之前的。
    * priority必须为0。这个很好理解，数据都不全，成为primary就悲剧了。hidden应该为true，理论上延迟节点的数据可以被读取，但是读取的数据不是最新的，有啥用呢？
    * 使用场景
        - 升级或者不小心操作失误，删除了表、库，可以通过延迟节点恢复数据，因为其他节点在primary执行删除的同时，也把删除操作同步了，只有延迟节点不是立马同步的。

### 3.1.3 选举节点      
由于成本的限制，没法做到多个节点的副本集，这时候可以增加一些选举节点，选举节点不存储数据，但是拥有投票权，在primary挂掉的时候，可以参与新primary的选举。**有啥用？**


## 3.2 操作日志     

### 3.2.1 oplog是什么     
一个特殊的集合，记录了数据库所有的操作。

### 3.2.2 oplog的大小

#### 3.2.2.1 默认大小 
oplog的默认大小，会区分操作系统和使用的存储引擎。

|操作系统|存储引擎|默认大小|最小|最大|
|-------|-------|--------|---|----|
|unix/windows|In-Memory Storage|5%的物理内存|50M|50G|
|unix/windows|WiredTiger Storage|5%的磁盘|990M|50G|
|macOs|In-Memory Storage|192 MB内存 |/|/|
|macOs|WiredTiger Storage|192 MB 磁盘|/|/|

#### 3.2.2.2 何时需要更大容量 

+ 有很多的批量更新。
+ 删除操作和插入操作一样多。
+ 大量的就地更新。

上面的这些操作，都是那种对数据控件影响不大，但是会产生大量oplog的操作。如果业务场景符合这些的，可以增加oplog的存储大小。

### 3.2.3 oplog的生命周期
oplog记录的是数据库所有数据的变更，理论上应该要能全部记录，但是空间终究是有限的，所以oplog的内容也会有删除的情况。mongodb 4.4版本以后，oplog只会在以下两种情况下删除:

+ 1、 oplog大小超过配置的最大空间。 
+ 2、 oplog超过了配置的最大保留时间。

简单讲，就是过量或者过期。
如果需要删除oplog，会删除最早的数据，保留最新的数据。

## 3.3 数据的同步



