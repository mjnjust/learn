[TOC]
# 副本集
+ 文档主要内容
    * 冗余和数据可用性
    * mongodb中的复制
    * 异步复制
    * 自动故障转移
    * 读取操作
    * 事务
    * 更改流
    * 额外参数

副本集是一组拥保持着相同数据的mongdb进程。副本集提供了容错和高可用性，是生产环境部署的基础。本章介绍了mongdb的赋值和副本集的组件与体系结构。本节还提供了和副本集相关的常用任务的教程。

### 冗余和数据可用性
数据复制提供了容错并且提高了数据可用性。通过在不同数据服务器上存储数据的拷贝，复制集提供了针对单个数据服务器丢失的容错级别。

在一些场景中，复制可以提高数据读取能力，因为客户端可以将读操作发送到不同的服务器上。在不同的数据中心持有数据的副本，可以提高分布式应用的数据局部性和可用性。你也可以为一些特别的目的增加副本，比如容灾、报告、数据备份。

### mongdb中的复制
副本集时持有相同数据的一组mongdb实例。一个副本集包含了几个数据承载节点和一个可选的仲裁节点。在数据承载节点中，有且仅有一个成员节点可以作为主节点，其余的作为从节点。

主节点接受所有的写请求。一个副本集只有主节点通过{w:"majority"}的配置可以拥有写确认的能力；尽管在一些情况下，其余节点也可能会认为自己能够成为主节点。主节点会在操作日志中记录数据的所有变动，这样的日志叫oplog。

![avatar](https://docs.mongodb.com/manual/_images/replica-set-read-write-operations-primary.bakedsvg.svg)

从节点复制主节点的操作日志(oplog)并将这些操作加入到自己的数据集合中，这样从节点就可以得到主节点的数据副本。如果主节点出现问题，一个合格的从节点会发起一次选举，推荐自己成为新的主节点。

![avatar](https://docs.mongodb.com/manual/_images/replica-set-primary-with-two-secondaries.bakedsvg.svg)

在一些场景中(比如已经有一个主节点一个从节点，但是因为成本问题不能再多加一个从节点)，你可以选择向副本集中加入一个仲裁者节点。仲裁者节点在选举时可以投票但是不会持有数据。

![avatar](https://docs.mongodb.com/manual/_images/replica-set-primary-with-secondary-and-arbiter.bakedsvg.svg)

在一次选举中，主节点可能会降级变成从节点，而从节点也可能会变成主节点，但是仲裁者节点将永远是仲裁者节点。

### 异步复制
从节点异步的从主节点复制操作日志并讲操作加入到自己的数据集合中。因为从节点和主节点保持着相同的数据，因此即使一个甚至多个节点不可用时，副本集仍然可以对外提供服务。

+ #### 慢操作
    4.2版本开始(其实从4.0.6版本就可以)，副本集的从节点现在会记录比慢操作阈值耗时更长的操作日志。REPL组件为从节点记录下这些日志，其日志格式为:  
    ```
    <oplog entry> took <num>ms.
    ```
    这些慢操作日志只依赖慢操作的阈值，它们不依赖日志的级别、分析的界别或者慢操作的采样率。探查器不捕获慢操作的条目。

+ #### 复制延迟和流量控制    
    
    复制延迟是指从节点从主节点复制数据所需要的的时间。一些小的延迟是可以接受的，但是随着延迟的增加，可能会引起一些大的问题，比如增大主节点的缓存压力。

    从4.2版本开始，管理员可以限制主节点应用写操作的速率，以此来把大多数的数据提交延迟控制在可配置的最大值 flowcontroltargetlagsseconds 之下。
    流量控制默认是关闭的。

    ```
    要启用流量控制，副本集必须满足两个条件:4.2版本，启用了多数读取的配置。
    也就是说，如果是4.2版本一下或者多数读取的配置没有开启，那么流量控制是没有作用的。
    ```

    流量控制开启了之后，如果复制延迟增长到接近配置的flowcontroltargetlagsseconds值，主节点在应用写操作之前必须获取票证，通过限制每秒发出的票证数量，可以控制延迟在目标值之下。(也就是当延迟达到一定程度的时候写操作会受信号量的控制)

### 自动故障转移   
    
如果一个主节点和其他的副本集成员失去联系超过一个设定的时间(electionTimeoutMillis配置项，默认是10秒)，一个合格的从节点会发起一个投票，举荐自己成为新的主节点。集群会尝试完成这次投票，然后重新开始提供服务。

![avatar](https://docs.mongodb.com/manual/_images/replica-set-trigger-election.bakedsvg.svg)

在投票成功完成之前，副本集无法提供写的服务。但是如果配置了从节点可以提供读取服务，那么即使主节点离线，集群仍然可以提供读的服务。


