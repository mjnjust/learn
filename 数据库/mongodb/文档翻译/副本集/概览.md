[TOC]
# 副本集
+ 文档主要内容
    * 冗余和数据可用性
    * mongodb中的复制
    * 异步复制
    * 自动故障转移
    * 读取操作
    * 事务
    * 更改流
    * 其余特性

副本集是一组拥保持着相同数据的mongdb进程。副本集提供了容错和高可用性，是生产环境部署的基础。本章介绍了mongdb的赋值和副本集的组件与体系结构。本节还提供了和副本集相关的常用任务的教程。

### 冗余和数据可用性
数据复制提供了容错并且提高了数据可用性。通过在不同数据服务器上存储数据的拷贝，复制集提供了针对单个数据服务器丢失的容错级别。

在一些场景中，复制可以提高数据读取能力，因为客户端可以将读操作发送到不同的服务器上。在不同的数据中心持有数据的副本，可以提高分布式应用的数据局部性和可用性。你也可以为一些特别的目的增加副本，比如容灾、报告、数据备份。

### mongdb中的复制
副本集时持有相同数据的一组mongdb实例。一个副本集包含了几个数据承载节点和一个可选的仲裁节点。在数据承载节点中，有且仅有一个成员节点可以作为主节点，其余的作为从节点。

主节点接受所有的写请求。一个副本集只有主节点通过{w:"majority"}的配置可以拥有写确认的能力；尽管在一些情况下，其余节点也可能会认为自己能够成为主节点。主节点会在操作日志中记录数据的所有变动，这样的日志叫oplog。

![avatar](https://docs.mongodb.com/manual/_images/replica-set-read-write-operations-primary.bakedsvg.svg)

从节点复制主节点的操作日志(oplog)并将这些操作加入到自己的数据集合中，这样从节点就可以得到主节点的数据副本。如果主节点出现问题，一个合格的从节点会发起一次选举，推荐自己成为新的主节点。

![avatar](https://docs.mongodb.com/manual/_images/replica-set-primary-with-two-secondaries.bakedsvg.svg)

在一些场景中(比如已经有一个主节点一个从节点，但是因为成本问题不能再多加一个从节点)，你可以选择向副本集中加入一个仲裁者节点。仲裁者节点在选举时可以投票但是不会持有数据。

![avatar](https://docs.mongodb.com/manual/_images/replica-set-primary-with-secondary-and-arbiter.bakedsvg.svg)

在一次选举中，主节点可能会降级变成从节点，而从节点也可能会变成主节点，但是仲裁者节点将永远是仲裁者节点。

### 异步复制
从节点异步的从主节点复制操作日志并讲操作加入到自己的数据集合中。因为从节点和主节点保持着相同的数据，因此即使一个甚至多个节点不可用时，副本集仍然可以对外提供服务。

+ #### 慢操作
    4.2版本开始(其实从4.0.6版本就可以)，副本集的从节点现在会记录比慢操作阈值耗时更长的操作日志。REPL组件为从节点记录下这些日志，其日志格式为:  
    ```
    <oplog entry> took <num>ms.
    ```
    这些慢操作日志只依赖慢操作的阈值，它们不依赖日志的级别、分析的界别或者慢操作的采样率。探查器不捕获慢操作的条目。

+ #### 复制延迟和流量控制    
    
    复制延迟是指从节点从主节点复制数据所需要的的时间。一些小的延迟是可以接受的，但是随着延迟的增加，可能会引起一些大的问题，比如增大主节点的缓存压力。

    从4.2版本开始，管理员可以限制主节点应用写操作的速率，以此来把大多数的数据提交延迟控制在可配置的最大值 flowcontroltargetlagsseconds 之下。
    流量控制默认是关闭的。

    ```
    要启用流量控制，副本集必须满足两个条件:4.2版本，启用了多数读取的配置。
    也就是说，如果是4.2版本一下或者多数读取的配置没有开启，那么流量控制是没有作用的。
    ```

    流量控制开启了之后，如果复制延迟增长到接近配置的flowcontroltargetlagsseconds值，主节点在应用写操作之前必须获取票证，通过限制每秒发出的票证数量，可以控制延迟在目标值之下。(也就是当延迟达到一定程度的时候写操作会受信号量的控制)

### 自动故障转移   
    
如果一个主节点和其他的副本集成员失去联系超过一个设定的时间(electionTimeoutMillis 配置项，默认是10秒)，一个合格的从节点会发起一个投票，举荐自己成为新的主节点。集群会尝试完成这次投票，然后重新开始提供服务。

![avatar](https://docs.mongodb.com/manual/_images/replica-set-trigger-election.bakedsvg.svg)

在投票成功完成之前，副本集无法提供写的服务。但是如果配置了从节点可以提供读取服务，那么即使主节点离线，集群仍然可以提供读的服务。

默认配置下，集群选择出新的主节点所消耗的时间，不应超过12秒。这包括确认主节点是否不可用、发起并完成投票。可以通过副本集的settings.electionTimeoutMillis配置修改这个时间。网络延迟等因素会影响完成投票的耗时，而这直接会影响集群失去主节点后恢复服务的耗时。这些因素一般取决于集群的整体架构。

减小 electionTimeoutMillis 的默认值(10秒)，可以更快的探测到主节点的不可用状态。但是这也会导致集群在网络延迟较高的时候，频繁的进行选举，即使这时候主节点是可用的。这可能会导致 w:1 写操作的回滚。

应用使用mongodb时，必须考虑到故障转移和之后进行的主节点选举(因为这会导致mongdb有一段时间的不可写)。从mongdb3.6版本之后，mongdb驱动可以自动发现主节点的不可用并且一次性的自动重试一些写操作，以此来提供一些内置的额外的处理故障转移和选举的选择:
    4.2版本的驱动默认会在故障时重试某些写操作。
    4.0和3.6版本的驱动需要手动的开启，需要在建立mongdb连接时加入参数 retryWrites=true 
4.4版本开始，mongdb提供了镜像读取功能，使用最近访问的热数据来预热哪些可以成为主节点的候选从节点的缓存。预热从节点的缓存可以帮助集群在选举之后更好的恢复性能。

### 读操作
+ #### 读取配置 
    默认情况下，客户端从主节点读取数据。但是客户端也可以将通过配置使用 从节点 来读取数据。

    ![avatar](https://docs.mongodb.com/manual/_images/replica-set-read-preference-secondary.bakedsvg.svg)

    异步复制可能会导致从从节点读取的数据并不能真实的反映主节点的数据状态。

    多文档事务操作必须从主节点读取数据，一个事务中的所有事务必须保证是在一个节点上进行的。

+ #### 数据可见性 
    根据读取策略，客户端可能读取到还未被持久化的数据:

    * 不管写操作的确认条件是什么，使用local或者available读取策略的客户端，在写操作被确认之前就可以读取到数据。
    * 使用local或者available读取策略可能会出现客户端读取到了数据，但是这些数据接下来被回滚了。
    
    对于一个多文档事务来说，当一个事务被提交，这个事务中的所有更改都会被保存并且事务之外也可见。也就是说，发生回滚的话，事务不会提交其中的部分操作，而是全部回滚。(不就是事务的原子性)

    在事务提交之前，所有的数据变更在事务之外是不可见的。

    但是如果一个事务涉及多个分片，事务之外的连接不需要等到所有分片的事务都提交成功才能读取数据。比如，一个事务涉及两个分片，在分片A执行的写操作1已经持久化成功，在分片B执行的写操作2还未成功，这时候写操作1的数据对于其余连接已经是可见状态了，即使写操作2的结果还无法被读取。(也就是说，分片集群中的事务，整体具有原子性，但是数据可见性是针对单分片而言的。)

+ #### 镜像读取  ?? 
    
    4.4版本开始，mongdb提供了镜像读取的能力来为主节点的候选从节点进行数据预热。通过镜像读取，主节点可以将一部分操作日志发送给一部分候选从节点，这部分候选从节点的数量是可以配置的。

    ```
    主节点对客户端的响应不会受镜像读取的影响。镜像读取操作是'fire-and-forget'模式的，类似于UDP。发送之后不关心响应。
    ```

    * 镜像读取支持的操作
        - count
        - distinct
        - find
        - findAndModify
        - update
    * 镜像读取的开关 ？？
    * 镜像读取的指标 ？？

### 事务 
4.0版本开始，副本集也支持多文档事务。多文档事务中的读操作必须使用主节点，事务中所有的操作必须是在同一个节点上完成的。

### 变更流
3.6版本开始，副本集和分片提供了变更流的功能。变更流允许应用读取到实时的数据，而不需要较高复杂度和不断的赋值oplog。

### 其余特性   
副本集提供很多操作来满足应用的需要。比如，你可以在多个数据中心部署你的成员节点，通过priority参数来控制选举的结果。副本集的一些成员也可以专门被用来做数据分析、容灾、数据备份等。  副本集中的成员，可以放弃成为主节点的权利，可以设置为应用不可见、可以延迟从主节点复制数据。具体的后续会有提到。








