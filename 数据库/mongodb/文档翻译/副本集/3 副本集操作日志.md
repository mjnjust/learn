[TOC]

## Replica Set Oplog
* Oplog Size
* Workloads that Might Require a Larger Oplog Size
* Oplog Status
* Slow Oplog Application
* Oplog Collection Behavior

oplog是一个记录数据库中所有数据操作的固定集合。
4.0版本开始，和其他的固定集合不同，oplog可以超过其配置的存储大小来避免删除大多数的提交确认点。(?? 没看懂，这个提交确认点是啥？)
4.4版本中，支持配置一个以小时为单位的oplog的保留期，mongodb只会在满足以下条件时删除oplog(简单讲就是，空间到限制了，有些数据也已经超过了最短保留期):  

* oplog已经达到了配置的最大空间设置。
* oplog已经达到了配置的最小保留期。

mongodb在主节点中执行数据操作，然后将操作记录到oplog中。从节点通过异步的进程复制并应用这些oplog。副本集成员持有一份oplog，存储在 local.oplog.rs 集合中，这使得从节点保持当前数据库的状态(应该是说保证了集群数据的一致)。

为了更好的进行复制，副本集成员之间会进行心跳检测，一个成员可以从任意一个其他成员中拷贝
oplog。

oplog的每一个操作都是幂等的，也就是说不论执行一次还是多次oplog中的操作，对于数据集产生的影响是一样的。(相当于可以被重复执行)

### oplog的大小
当你启动一个副本集成员的时候，如果你不明确的指定成员oplog的大小，那么mongodb会使用默认的oplog大小。

unix和windows系统默认大小如下:

| 存储引擎 | 默认大小 | 最低 | 最高 |
| ------- | --------| ----- | ---- |
| In-Memory | 5%的物理内存 | 50M | 50G |
| WiredTiger | 5%的硬盘 | 990M | 50G |

64位的mac系统(没有上下限?)

| 存储引擎 | 默认大小 |
| ------- | --------| 
| In-Memory | 192M |
| WiredTiger | 192M |

大多数情况下，默认大小的oplog是足够的。比如，一个硬盘5%空间的oplog，24小时内填满了，副本集可以停止备份24小时之前的数据，保证副本集复制的是最新的数据。(我的理解是，即使oplog满了，从节点也可以做到，剔除过期的日志，保留最新的数据。)但是，一般副本集不会有那么多的操作日志，因此可以保存更久远的日志。

在mongod进程创建oplog之前，你可以使用 oplogSizeMB 操作来指定oplog的大小。一旦你开始进行某个成员的oplog复制的时候，你就要使用 replSetResizeOplog 这个管理员命令来修改oplog的大小。这个命令允许你可以在不重启mongod的情况下修改oplog的大小。

### oplog的最短保留期
4.4版本开始，你可以指定oplog集合的最短存活时间(单位小时)。当某条oplog满足下面两个条件的时候，mongod进程会清理该条oplog:
* oplog集合大小以及达到了配置的最大空间。
* 基于主机的系统时钟，oplog的存活时间已经到配置的最短时间。

默认配置下，mongodb不设置oplog的最短保留期，并且从最早的oplog开始进行清理，以保持最大oplog大小。

要在运行时修改oplog的大小，可以使用 replSetResizeOplog 命令。在运行时设置保留期的话会覆盖启动时的配置，但是不会持久化这个新的配置。如果你想让这些配置在重启之后还有效，那么就需要更新相应的配置文件或命令行的参数。

### 需要更大oplog的负载
如果你可以预测你的副本集负载类似于下面的情况，那么你可能希望创建一个比默认oplog大的oplog。相反，如果你的应用是以读为主，那么可以设置一个小一点的oplog。

* 一次更新多个文件
记录oplog时，mongodb必须将批量更新转换为单个的更新，以保持幂等性。这会占用大量的oplog控件而不会导致数据空间的增长。
* 删除和插入操作一样多
如果大体上删除和插入操作一样多，那数据空间不会快速增长，但是oplog却需要更大的空间。
* 有大量的就地更新
就地更新是指不会导致数据空间变大的更新操作，数据库需要空间去记录更新操作但是数据空间本身却没有任何增长。

### oplog的状态
想要看oplog的状态，包括占用空间的大小、保留期的范围等，可以使用rs.printReplicationInfo() 这个方法。







