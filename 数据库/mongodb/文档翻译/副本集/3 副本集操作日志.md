[TOC]

## Replica Set Oplog
* Oplog Size
* Workloads that Might Require a Larger Oplog Size
* Oplog Status
* Slow Oplog Application
* Oplog Collection Behavior

oplog是一个记录数据库中所有数据操作的固定集合。
4.0版本开始，和其他的固定集合不同，oplog可以超过其配置的存储大小来避免删除大多数的提交确认点。(?? 没看懂，这个提交确认点是啥？)
4.4版本中，支持配置一个以小时为单位的oplog的保留期，mongodb只会在满足以下条件时删除oplog(简单讲就是，空间到限制了，有些数据也已经超过了最短保留期):  

* oplog已经达到了配置的最大空间设置。
* oplog已经达到了配置的最小保留期。

mongodb在主节点中执行数据操作，然后将操作记录到oplog中。从节点通过异步的进程复制并应用这些oplog。副本集成员持有一份oplog，存储在 local.oplog.rs 集合中，这使得从节点保持当前数据库的状态(应该是说保证了集群数据的一致)。

为了更好的进行复制，副本集成员之间会进行心跳检测，一个成员可以从任意一个其他成员中拷贝
oplog。

oplog的每一个操作都是幂等的，也就是说不论执行一次还是多次oplog中的操作，对于数据集产生的影响是一样的。(相当于可以被重复执行)

### oplog的大小
当你启动一个副本集成员的时候，如果你不明确的指定成员oplog的大小，那么mongodb会使用默认的oplog大小。

unix和windows系统默认大小如下:

| 存储引擎 | 默认大小 | 最低 | 最高 |
| ------- | --------| ----- | ---- |
| In-Memory | 5%的物理内存 | 50M | 50G |
| WiredTiger | 5%的硬盘 | 990M | 50G |

64位的mac系统(没有上下限?)

| 存储引擎 | 默认大小 |
| ------- | --------| 
| In-Memory | 192M |
| WiredTiger | 192M |

大多数情况下，默认大小的oplog是足够的。比如，一个硬盘5%空间的oplog，24小时内填满了，副本集可以停止备份24小时之前的数据，保证副本集复制的是最新的数据。(我的理解是，即使oplog满了，从节点也可以做到，剔除过期的日志，保留最新的数据。)但是，一般副本集不会有那么多的操作日志，因此可以保存更久远的日志。









