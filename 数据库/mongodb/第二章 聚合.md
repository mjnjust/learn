[TOC]
# 2. 聚合

## 2.1 聚合框架 

### 2.1.1 aggregate函数  
- 和find、update一样，接受参数实现功能，是专门用来做聚合的函数。 
- 输入参数  
    输入参数是个 **数组** ，每个数组元素由一个构件构成。
- 返回参数  
    返回聚合之后的结果。

## 2.1.2 聚合构件   

### 2.1.2.1 什么是构件   
其实类似于操作符，每个构件对应一种功能而已，包括筛选（filtering）、投射（projecting）、分组（grouping）、排序（sorting）、限制（limiting）和跳过（skipping)等。

### 2.1.2.2 常用构件
在介绍各个构件之前，先假设数据库里有如下文档，后续的例子会使用该文档进行讲解。

    ```
    (name:文章名，author:作者，score:评分,commentId:评论的id，wxShare:微信的分享次数，weboShare:微博的分享次数)
    [
    {name:'test1',author:'zhangsan',score:1,commentId:[1,2,3,4,5],wxShare:10,weboShare:20,createTime:new Date()},
    {name:'test2',author:'zhangsan',score:4,commentId:[1,2,3,4,5],wxShare:10,weboShare:20,createTime:new Date()},
    {name:'test3',author:'lisi',score:4,commentId:[1,2,3,4,5],wxShare:10,weboShare:20,createTime:new Date()},
    {name:'test4',author:'wangwu',score:5,commentId:[1,2,3,4,5],wxShare:10,weboShare:20,createTime:new Date()},
    {name:'test5',author:'lisi',score:3,commentId:[1,2,3,4,5],wxShare:10,weboShare:20,createTime:new Date()},
    {name:'test6',author:'lisi',score:6,commentId:[1,2,3,4,5],wxShare:10,weboShare:20,createTime:new Date()}
    ]
    ```

- #### $project 
    投射，可以通过指定"fieldname" : 1选择需要投射的字段，或者通过指定"fieldname" : 0排除不需要的字段，类似于find语句中的字段选择。也可以将筛选的字段重新命名。

    + ##### 筛选
        通过指定fieldname = 0/1来进行筛选，_id默认会被取出。比如，将所有文章名和作者名取出来，就可以用

        ```
        db.getCollection('articles').aggregate([{$project:{name:1,author:1}}])
        ```

    + ##### 改名        
        如果取出的name想要改为articleName , 可以用

        ```
        db.getCollection('articles').aggregate([{$project:{aritcleName:$name}}])
        ```

    + ##### 数组的投射 ??
        如果想投射出数组中的某个下标的数据，可以直接用下标进行投射。比如现在需要投射出每篇文章第3个评论的id。就可以用

        ```

        ```
    
    + ##### 与表达式的结合       
        * ######  结合数学表达式  
            比如想要得到每篇文章对应的总分享次数，就可以:

            ```
            db.getCollection('articles').aggregate([
                {$project:{totalShare:{$add:['$wxShare','$weboShare']},name:1,_id:0}}
            ])
            ```
            
            这样，会将wxShare和weboShare相加，字段投射到tatalShare上。
            mongdb支持各种常见的数学表达式，如下：

            |    表达式     |     语法     |     作用    |   举例   |
            |---------------|--------------|------------|----------|
            | $add | "$add" : [expr1, expr2, ..., exprN] | 将传入的参数相加。 | \{$project:\{total:\{$add:['$a','$b',10]\}\}\} |
            | $subtract | "$subtract" : [expr1, expr2] | 计算expr1 - expr2 | \{$project:\{num:\{$subtract:['$a','$b']\}\} |
            | $multiply | "$multiply" : [expr1, expr2, ..., exprN] | 将传入的参数进行相乘 | $project:\{num:\{$multiply:['$a','$b','$c']\}\} |
            | $divide | "$divide" : [expr1, expr2] | 计算expr1/expr2,得到结果为double |  \{$project:\{num:\{$divide:['$a','$b']\}\} | 
            | $mod | "$mod" : [expr1, expr2] | 计算expr1%expr2 | \{$project:\{num:\{$mod:['$a','$b']\}\} |

        * ###### 日期表达式          
            可以针对日期类型的字段使用日期表达式。 比如想得到文章发布的年月:

            ```
            db.getCollection('articles').aggregate(
                [{$project:{year:{$year:'$createTime'},month:{$month:'$createTime'}}}]
            )
            ```
            
            常用的日期表达式如下:     

             |    表达式     |        作用       |    举例   |
             | -------------  |  ------------   | --------  |
             | $year |   取年份   |  \{$project:\{year:\{$year:'$createTime'\}\}\} | 
             | $month | 取月份，数值从1开始   |  \{$project:\{month:\{$month:'$createTime'\}\}\} | 
             | $dayOfMonth | 取日期，数值从1开始 |   \{$project:\{date:\{$dayOfMonth:'$createTime'\}\}\} | 
             | $week | 计算日期是其所在年份的第几周，数值从1开始。第一周从对应年份的第一个周日开始算起。 |   \{$project:\{week:\{$week:'$createTime'\}\}\} | 
             | $dayOfWeek | 计算日期是其所在周的第几天，数值从1开始，并且是从周日开始是第一天。 |   \{$project:\{dayOfWeek:\{$dayOfWeek:'$createTime'\}\}\} | 

            日期表达式也可以结合数学表达式进行计算，比如计算文章已经发布了多少年:

            ```
            db.getCollection('articles').aggregate(
                [{$project:{year:{$subtract:[{$year:'$createTime'},{$year:'$createTime'}]}}}]
            )
            ```

        * ###### 字符串表达式 
            就是对于字符串的一些操作。
            
            |    表达式  |    语法    |        作用       |    举例   |
            | ---------  | --------  | ------------ | --------- |
            | $substr   | "$substr" : [expr, startOffset, length] | 截取字符串,startOffset是字符串开始截取的下标，length是字符串截取的长度 | \{$project:\{x:\{$substr:['$name',0,1]\}\}\}) |
            | $concat | "$concat" : [expr1, expr2, ..., exprN] | 字符串拼接 |   \{project:\{x:\{$concat:['$name','a','b']\}\}\} |
            | $toLower | "$toLower" : expr | 转成小写字母 | \{project:\{x:\{$toLower:'$name'\}\}\} |
            | $toLower | "$toUpper" : expr | 转成小写字母 | \{project:\{x:\{$toUpper:'$name'\}\}\} |

        * ###### 逻辑表达式 
            通过逻辑表达式，可以进行一些控制。

            |    表达式  |    语法    |        作用       |    举例   |
            | ---------  | --------  | ------------ | --------- |
            | $cmp | "$cmp" : [expr1, expr2] | 比较expr1和expr2。如果expr1等于expr2，返回0；如果expr1 ＜ expr2，返回一个负数；如果expr1 ＞expr2，返回一个正数。比较的对象可以是一个数字、字符串，也可以是一个对象。对于比较的规则，我的理解是，数字比大小，其余的转成字符串进行字典方式的比较。 | \{$project:\{result:\{$cmp:['a','b']\}\}\} = -1 ，\{$project:\{result:\{$cmp:['c','b']\}\}\} = 1, \{$project:\{result:\{$cmp:[{name:'a'},{name:'b'}]\}\}\} = -1 | 
            | $strcasecmp | "$strcasecmp" : [string1, string2] | 比较string1和string2，区分大小写。只对罗马字符组成的字符串有效。 | \{$project:\{result:\{$strcasecmp:['a','b']\}\}\} = -1 |
            | $and | "$and" : [expr1, expr2, ..., exprN] | 相当于与，参数全部为true才为true | {$project:{result:{$and:[{$eq:['$name','test1']},true]}}} | 
            | $or | "$or" : [expr1, expr2, ..., exprN] | 相当于或 | {$project:{result:{$or:[{$eq:['$name','test1']},true]}}} |
            | $not | "$not" : expr | 取反 | | 
            
            还有两个功能更加强大的表达式，可以向if else 一样进行分支控制。

            |    表达式  |    语法    |        作用       |    举例   |
            | ---------  | --------  | ------------ | --------- |
            | $cond | "$cond" : [booleanExpr, trueExpr, falseExpr] | 如果 booleanExpr = true, 执行trueExpr,否则执行falseExpr | {$project:{result:{$cond:[{$eq:['$name','test1']},1,2]}}}，如果name = test1，那么返回1，否则返回2。 |
            | $ifNull | "$ifNull" : [expr, replacementExpr] | 如果expr = null，返回replacementExpr，否则返回expr，就相当于如果expr是null，那么可以有个默认值 | {$project:{result:{$ifNull:[null,1]}}} | 

- #### $group   
    + 分组    
        group最基本的功能就是分组，根据某个或某几个字段进行分组，比如想要知道有哪些作者，可以 {$group:{_id:'$author'}} ， 这里的 _id 就是分组使用的依据。














