[TOC]
# 2. 聚合

## 2.1 聚合框架 

### 2.1.1 aggregate函数  
- 和find、update一样，接受参数实现功能，是专门用来做聚合的函数。 
- 输入参数  
    输入参数是个 **数组** ，每个数组元素由一个构件构成。
- 返回参数  
    返回聚合之后的结果。

## 2.1.2 聚合构件   

### 2.1.2.1 什么是构件   
其实类似于操作符，每个构件对应一种功能而已，包括筛选（filtering）、投射（projecting）、分组（grouping）、排序（sorting）、限制（limiting）和跳过（skipping)等。

### 2.1.2.2 常用构件
在介绍各个构件之前，先假设数据库里有如下文档，后续的例子会使用该文档进行讲解。

    ```
    (name:文章名，author:作者，score:评分)
    [
    {name:'test1',author:'zhangsan',score:1,commentId:[1,2,3,4,5],wxShare:10,weboShare:20},
    {name:'test2',author:'zhangsan',score:4,commentId:[1,2,3,4,5],wxShare:10,weboShare:20},
    {name:'test3',author:'lisi',score:4,commentId:[1,2,3,4,5],wxShare:10,weboShare:20},
    {name:'test4',author:'wangwu',score:5,commentId:[1,2,3,4,5],wxShare:10,weboShare:20},
    {name:'test5',author:'lisi',score:3,commentId:[1,2,3,4,5],wxShare:10,weboShare:20},
    {name:'test6',author:'lisi',score:6,commentId:[1,2,3,4,5],wxShare:10,weboShare:20}
    ]
    ```

- #### $project 
    投射，可以通过指定"fieldname" : 1选择需要投射的字段，或者通过指定"fieldname" : 0排除不需要的字段，类似于find语句中的字段选择。也可以将筛选的字段重新命名。

    + 筛选
        通过指定fieldname = 0/1来进行筛选，_id默认会被取出。比如，将所有文章名和作者名取出来，就可以用

        ```
        db.getCollection('articles').aggregate([{$project:{name:1,author:1}}])
        ```

    + 改名        
        如果取出的name想要改为articleName , 可以用

        ```
        db.getCollection('articles').aggregate([{$project:{aritcleName:$name}}])
        ```

    + 数组的投射 ??
        如果想投射出数组中的某个下标的数据，可以直接用下标进行投射。比如现在需要投射出每篇文章第3个评论的id。就可以用

        ```

        ```
    
    + 与表达式的结合       
        * 结合数学表达式  
            比如想要得到每篇文章对应的总分享次数，就可以:

            ```
            db.getCollection('articles').aggregate([
                {$project:{totalShare:{$add:['$wxShare','$weboShare']},name:1,_id:0}}
            ])
            ```
            
            这样，会将wxShare和weboShare相加，字段投射到tatalShare上。
            mongdb支持各种常见的数学表达式，如下：

            |    表达式     |     语法     |     作用    |   举例   |
            |---------------|--------------|------------|----------|
            | $add | "$add" : [expr1, expr2, ..., exprN] | 将传入的参数相加。 | \{$project:\{total:\{$add:['$a','$b',10]\}\}\} |
            | $subtract | "$subtract" : [expr1, expr2] | 计算expr1 - expr2 | \{$project:\{num:\{$subtract:['$a','$b']\}\} |
            | $multiply | "$multiply" : [expr1, expr2, ..., exprN] | 将传入的参数进行相乘 | $project:\{num:\{$multiply:['$a','$b','$c']\}\} |
            | $divide | "$divide" : [expr1, expr2] | 计算expr1/expr2,得到结果为double |  \{$project:\{num:\{$divide:['$a','$b']\}\} | 
            | $mod | "$mod" : [expr1, expr2] | 计算expr1%expr2 | \{$project:\{num:\{$mod:['$a','$b']\}\} |

        * 日期表达式          
            可以针对日期类型的字段使用日期表达式。
            
